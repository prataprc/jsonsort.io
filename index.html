<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Sorting Json data, crazy fast !</title>
<meta property="og:title" content="Sorting Json data, crazy fast !" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/jsonsort.io/" />
<meta property="og:url" content="http://localhost:4000/jsonsort.io/" />
<meta property="og:site_name" content="Sorting Json data, crazy fast !" />
<script type="application/ld+json">
{"name":"Sorting Json data, crazy fast !","description":null,"author":null,"@type":"WebSite","url":"http://localhost:4000/jsonsort.io/","publisher":null,"image":null,"headline":"Sorting Json data, crazy fast !","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/jsonsort.io/assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="Sorting Json data, crazy fast !" href="/jsonsort.io/feed.xml">
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/jsonsort.io/">Sorting Json data, crazy fast !</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  

  <p>Collation is sorting data in relation to each other. That is, to figure
out what comes before and what comes after.</p>

<p>Let us begin with numbers, more specifically let us try to sort a set of
numbers: <code class="highlighter-rouge">{100, 346, 20, 560}</code>. It is quite obvious how the sorted set
of numbers will look like: <code class="highlighter-rouge">{20, 100, 346, 560}</code>. For instance
following snippet of program, also called as bubble sort, can do the
sorting business for us:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">bubblesort</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">list</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">100</span><span class="p">,</span><span class="x"> </span><span class="m">346</span><span class="p">,</span><span class="x"> </span><span class="m">20</span><span class="p">,</span><span class="x"> </span><span class="m">560</span><span class="p">}</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">itemCount</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="x"> </span><span class="o">-</span><span class="x"> </span><span class="m">1</span><span class="p">;</span><span class="x"> </span><span class="p">;</span><span class="x"> </span><span class="n">itemCount</span><span class="o">--</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">hasChanged</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="no">false</span><span class="x">
        </span><span class="k">for</span><span class="x"> </span><span class="n">index</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="m">0</span><span class="p">;</span><span class="x"> </span><span class="n">index</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="n">itemCount</span><span class="p">;</span><span class="x"> </span><span class="n">index</span><span class="o">++</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="k">if</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="x"> </span><span class="o">&gt;</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="m">1</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
                </span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="m">1</span><span class="p">]</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="m">1</span><span class="p">],</span><span class="x"> </span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="x">
                </span><span class="n">hasChanged</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
            </span><span class="p">}</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">hasChanged</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">false</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="k">break</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>In the above program, <code class="highlighter-rouge">a[index] &gt; a[index+1]</code> is the comparator to sort
our number set. This expression will be compiled into machine instruction
that can compare two 64-bit integers, provided the operands to comparator
are of type integer and hence stored either in little-endian or big-endian
binary format (depending on the processor). Will above comparator expression
or its corresponding machine instruction work if our data type is supplied
like this,</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">list</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"100"</span><span class="p">,</span><span class="x"> </span><span class="s">"346"</span><span class="p">,</span><span class="x"> </span><span class="s">"20"</span><span class="p">,</span><span class="x"> </span><span class="s">"560"</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>So what is the difference ? In the second case we are supplying the integers
in ASCII format, or TEXT format, or more specifically as string type. Can
we use the same comparator expression, that we used for integer type ?
Some languages, especially those that are dynamically typed can automagically
pick the right comparator function, at runtime, based on the type of its
operands. Nevertheless, the comparator functions are going to be distinctly
different and so its output.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s">"100"</span><span class="p">,</span> <span class="s">"346"</span><span class="p">,</span> <span class="s">"20"</span><span class="p">,</span> <span class="s">"560"</span><span class="p">]</span>
<span class="o">&gt;</span> <span class="nb">list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="nb">list</span>
<span class="p">[</span><span class="s">'100'</span><span class="p">,</span> <span class="s">'20'</span><span class="p">,</span> <span class="s">'346'</span><span class="p">,</span> <span class="s">'560'</span><span class="p">]</span>
</code></pre></div></div>

<p>The comparator function used to sort a list of numbers represented in string
type is not really working out. What went wrong ? Our mistake was in
choosing a wrong comparator function by choosing a wrong data representation.</p>

<p><strong>This is the central problem of Collating JSON data. All data in JSON format
are meant to be in human readable text format</strong></p>

<h2 id="internet-web-and-json">Internet, Web and JSON</h2>

<p>Web is the human view of internet and JSON is the text representation of
web data.</p>

<p>Every data type, be it simple types like number, string, boolean, and
nil or composite types like array and property-object are all represented
in text for human consumption which, unfortunately, machines cannot
understand without parsing that text representation into binary
representation. To get an idea on how costly it is, let us try an experiment
to sort numbers in JSON format and compare it with native integers.</p>

<p>First let us try sorting a large set of native integers:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)))</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ls</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"took </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
<span class="o">//</span> <span class="n">output</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">2015</span> <span class="n">model</span> <span class="n">mac</span><span class="o">-</span><span class="n">book</span><span class="o">-</span><span class="n">pro</span>
<span class="o">//</span> <span class="n">took</span> <span class="mf">0.0256040096283</span> <span class="n">seconds</span>
</code></pre></div></div>

<p>Next let us try sorting a large set of integers in text (JSON) representation,
our program uses python’s magic of dynamic programming to override comparator
function used by <code class="highlighter-rouge">list.sort</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">I</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">))</span> <span class="p">]</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ls</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"took </span><span class="si">%</span><span class="s">s seconds"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
<span class="o">//</span> <span class="n">output</span> <span class="n">on</span> <span class="n">a</span> <span class="mi">2015</span> <span class="n">model</span> <span class="n">mac</span><span class="o">-</span><span class="n">book</span><span class="o">-</span><span class="n">pro</span>
<span class="o">//</span> <span class="n">took</span> <span class="mf">1.69596195221</span> <span class="n">seconds</span>
</code></pre></div></div>

<p><strong>Sorting 1 Million numbers in text representation takes 66 times more
CPU than sorting 1 Million machine native 64-bit integers</strong>.</p>

<h2 id="sorting-data-in-json-format">Sorting data in JSON format</h2>

<p>Our objective is to compile data from JSON format to a binary format
without losing any information contained in the data. We have two goals
to achive in doing so:</p>

<ul>
  <li>Preserve the sort order of input text. That is, after we compile a
set of JSON encoded data into a binary format, we should be able use
<strong>memcmp</strong> as the comparator function to sort encoded data, and the
sorted set should preserve the sort order as if they are compared
by parsing the JSON text.</li>
  <li>Binary compiled output shall be decoded back to JSON text without losing
any information.</li>
</ul>

<p>To sort data we need a strong idea of what come before and what comes
after. Before working out a sort order for each JSON type let us
work out a sort order between all JSON types:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Terminator</span><span class="x">  </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">0</span><span class="x">

</span><span class="n">TypeNull</span><span class="x">    </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">50</span><span class="x">
</span><span class="n">TypeFalse</span><span class="x">   </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">60</span><span class="x">
</span><span class="n">TypeTrue</span><span class="x">    </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">70</span><span class="x">
</span><span class="n">TypeNumber</span><span class="x">  </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">80</span><span class="x">
</span><span class="n">TypeString</span><span class="x">  </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">90</span><span class="x">
</span><span class="n">TypeLength</span><span class="x">  </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">100</span><span class="x">
</span><span class="n">TypeArray</span><span class="x">   </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">110</span><span class="x">
</span><span class="n">TypeObj</span><span class="x">     </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">120</span><span class="x">
</span><span class="n">TypeBinary</span><span class="x">  </span><span class="kt">byte</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">130</span><span class="x">
</span></code></pre></div></div>

<p>After compiling the JSON value into binary format it is prefixed with
one-byte type value, and suffixed by Terminator byte. A list of such
type prefix is provided above. Although <code class="highlighter-rouge">TypeTrue</code> and <code class="highlighter-rouge">TypeFalse</code> are
of same type, to save memory footprint, we shall include them in type
ordering as distinct types.</p>

<p>Sort order for each JSON type:</p>

<h3 id="null">Null</h3>

<p>This is a single value type and all null values shall be encoded as:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="x"> </span><span class="o">./</span><span class="n">gson</span><span class="x"> </span><span class="o">-</span><span class="n">inptxt</span><span class="x"> </span><span class="n">null</span><span class="x"> </span><span class="o">-</span><span class="n">json2collate</span><span class="x">
</span><span class="n">Json</span><span class="o">:</span><span class="x"> </span><span class="n">null</span><span class="x">
</span><span class="n">Coll</span><span class="o">:</span><span class="x"> </span><span class="s">"2</span><span class="se">\x00</span><span class="s">"</span><span class="x">
</span><span class="n">Coll</span><span class="o">:</span><span class="x"> </span><span class="p">[</span><span class="m">50</span><span class="x"> </span><span class="m">0</span><span class="p">]</span><span class="x">
</span></code></pre></div></div>

<p>Null values will sort before any other JSON value.</p>

<h3 id="boolean">Boolean</h3>

<p>There are two values, <code class="highlighter-rouge">false</code> and <code class="highlighter-rouge">true</code>. Value <code class="highlighter-rouge">true</code> will sort after
value <code class="highlighter-rouge">false</code>, while value <code class="highlighter-rouge">false</code> will always sort after JSON null value.
Boolean false and true shall be encoded as:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gson <span class="nt">-inptxt</span> <span class="nb">false</span> <span class="nt">-json2collate</span>
Json: <span class="nb">false
</span>Coll: <span class="s2">"&lt;</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>60 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="nb">true</span> <span class="nt">-json2collate</span>
Json: <span class="nb">true
</span>Coll: <span class="s2">"F</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>70 0]
</code></pre></div></div>

<h3 id="number">Number</h3>

<p>Number is the trickiest element of all JSON types. To begin with, JSON
specification does not define an lower or upper bound for numbers.
And many implementation treat JSON numbers as float64 type. But
fortunately we have strong conception of number sequence. There are two
choices that can be taken when encoding number:</p>

<ul>
  <li>Numbers can be treated as <strong>float64</strong> defined by IEEE-754 specification.
This implies that, only integers less than 2^53 and greater than -2^53
can be represented using this format.</li>
  <li>JSON parsers can automatically detect integers outside 2^53 boundary.</li>
</ul>

<p>The trade-off between the two is that, former implementation may consume less
CPU while later implementation will be future proof. Either way, we will
be encoding all number as arbitrarily sized floating point.</p>

<p>Encoding numbers is based on the paper
<a href="collate.pdf">Efficient Lexicographic Encoding of Numbers</a>. <code class="highlighter-rouge">Section 2:
Natural numbers</code> from the paper describe the basic idea in encoding
natural numbers of arbitrary size, <code class="highlighter-rouge">Section 3: Integers</code> extends this idea
to negative numbers there by covering the full set of integers, and
<code class="highlighter-rouge">Section 3: Small Decimals</code> apply similar idea to decimal set r ∈ (0,1). Based
on the ideas articulated from these three sections, we will further improvise
them to encode floating point numbers of arbitrary length.</p>

<p>A floating point number <code class="highlighter-rouge">f</code> takes a mantissa <code class="highlighter-rouge">m</code> and an integer exponent
<code class="highlighter-rouge">e</code> such that <code class="highlighter-rouge">f = 10e × ±m</code>. Unlike the IEEE-754 specification mantissa and
exponent can be of arbitrary length which helps us to encode very larger
numbers. The mantissa will always have a non-zero digit after the point
and for each number <code class="highlighter-rouge">f</code> will have a unique exponent. This is the normalised
representation and ensures comparison can be determined by the exponent where
it differs otherwise by the mantissa.</p>

<p>The floating point number is then a triple <code class="highlighter-rouge">(+, e, m)</code> or <code class="highlighter-rouge">(−, −e, m)</code>
consisting of a sign followed by the exponent and mantissa. The exponent
is represented as an integer using the recursive method and is negated for
negative numbers to ensure ordering. The mantissa is represented as a
positive small decimal but its sign must appear at the front of the entire
representation. As with large decimals there is no need to include a
delimiter since the exponent is length prefixed. Zero is represented as
0 since a sign symbol will be used for all other numbers. Following is a
set of examples:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>float           binary compiled

−0.1 × 10^11    - --7888+
−0.1 × 10^10    - --7898+
-1.4            - -885+
-1.3            - -886+
-1              - -88+
-0.123          - 0876+
-0.0123         - +1876+
-0.001233       - +28766+
-0.00123        - +2876+
0               0
+0.00123        + -7123-
+0.001233       + -71233-
+0.0123         + -8123-
+0.123          + 0123-
+1              + +11-
+1.3            + +113-
+1.4            + +114-
+0.1 × 10^10    + ++2101-
+0.1 × 10^11    + ++2111-
</code></pre></div></div>

<h3 id="string">String</h3>

<p>ASCII formatted strings are similar to binary comparison of byte arrays.
Every character in ASCII has a corresponding byte value and byte order has
one-to-one correspondence with character ordering. This get complicated once
we move on to Unicoded strings.</p>

<p>Strings are collated as it is received from the input <strong>without un-quoting</strong>
as JSON-string and <strong>without unicode collation</strong>. Encoded strings shall be
byte stuffed to escape item Terminator.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s1">'"hello\x00world"'</span> <span class="nt">-json2collate</span>
Json: <span class="s2">"hello</span><span class="se">\x</span><span class="s2">00world"</span>
Coll: <span class="s2">"Zhello</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">0100world</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>90 104 101 108 108 111 0 1 48 48 119 111 114 108 100 0 0]
</code></pre></div></div>

<h3 id="array">Array</h3>

<p>Sorting arrays have two aspects to it.</p>

<p>One, we should compare each item from both the array one after the other in
their positional order. If items are of different types then we should
follow the sort order between types.</p>

<p>Second aspect of sorting array is its arity, whether array with larger number
of items should sort after array with smaller number of items. If arity of
array needs to be considered, then we shall compare the length of each array
before comparing each item from both the array.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s2">"[10,true,null]"</span> <span class="nt">-json2collate</span>
Json: <span class="o">[</span>10,true,null]
Coll: <span class="s2">"nP&gt;&gt;21-</span><span class="se">\x</span><span class="s2">00F</span><span class="se">\x</span><span class="s2">002</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>110 80 62 62 50 49 45 0 70 0 50 0 0]
</code></pre></div></div>

<p><strong>For partial compare between two binary-compiled arrays, prune the last byte
from the encoded text of smaller array and continue with binary comparison.</strong>
This is because of the Terminator byte suffixed to encoded JSON value.</p>

<h3 id="property">Property</h3>

<p>Sorting arrays have three aspects to it.</p>

<p>A property object is made up <code class="highlighter-rouge">{key,value}</code> pairs, where key must be a JSON
string, and value can be of any JSON type. For the purpose of sorting, we
shall first sort the {key,value} pairs within a property object based on
the <code class="highlighter-rouge">key</code> string.</p>

<p>Secondly, we pick each {key,value} pair from both the property in its
positional order and start the comparison, <code class="highlighter-rouge">key</code> is compared first
and <code class="highlighter-rouge">value</code> is compared only when <code class="highlighter-rouge">key</code> from each item compares equal.</p>

<p>Third aspect of sorting property is its arity, whether property with
larger number of items should sort after property with smaller number
of items. If arity of property needs to be considered, then we shall
compare the length of each property before comparing each <code class="highlighter-rouge">{key,value}</code>
item from both the property.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s1">'{"first":true, "second":false}'</span> <span class="nt">-json2collate</span>
Json: <span class="o">{</span><span class="s2">"first"</span>:true, <span class="s2">"second"</span>:false<span class="o">}</span>
Coll: <span class="s2">"xd&gt;2</span><span class="se">\x</span><span class="s2">00Zfirst</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00F</span><span class="se">\x</span><span class="s2">00Zsecond</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00&lt;</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>120 100 62 50 0 90 102 105 114 115 116 0 0 70 0 90 115 101 99 111 110 100 0 0 60 0 0]
</code></pre></div></div>
<h3 id="gson">Gson</h3>

<p>A full implementation of JSON collation is available in
<a href="https://github.com/bnclabs/gson">gson-repository</a> hosted by github. It is implemented in
<a href="http://golang.org/">golang</a> and open sourced under MIT license. A command like tool
is supplied with the code to play with different encoding format - GSON can
encode common types into <a href="https://www.json.org/">JSON</a> format, <a href="http://cbor.io/">CBOR</a> format
and binary collation described in this page. Please <a href="https://golang.org/doc/install">install
golang</a> to try following example:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>gson/cmd
<span class="nv">$ </span>go build
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> null <span class="nt">-json2collate</span>
Json: null
Coll: <span class="s2">"2</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>50 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="nb">true</span> <span class="nt">-json2collate</span>
Json: <span class="nb">true
</span>Coll: <span class="s2">"F</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>70 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="nb">false</span> <span class="nt">-json2collate</span>
Json: <span class="nb">false
</span>Coll: <span class="s2">"&lt;</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>60 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s2">"-1231.1231"</span> <span class="nt">-json2collate</span>
Json: <span class="nt">-1231</span>.1231
Coll: <span class="s2">"P--587688768&gt;</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>80 45 45 53 56 55 54 56 56 55 54 56 62 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s1">'"hello world"'</span> <span class="nt">-json2collate</span>
Json: <span class="s2">"hello world"</span>
Coll: <span class="s2">"Zhello world</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>90 104 101 108 108 111 32 119 111 114 108 100 0 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s1">'["hello world"]'</span> <span class="nt">-json2collate</span>
Json: <span class="o">[</span><span class="s2">"hello world"</span><span class="o">]</span>
Coll: <span class="s2">"nZhello world</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>110 90 104 101 108 108 111 32 119 111 114 108 100 0 0 0]
<span class="nv">$ </span>./gson <span class="nt">-inptxt</span> <span class="s1">'{"hello": "world"}'</span> <span class="nt">-json2collate</span>
Json: <span class="o">{</span><span class="s2">"hello"</span>: <span class="s2">"world"</span><span class="o">}</span>
Coll: <span class="s2">"xd&gt;1</span><span class="se">\x</span><span class="s2">00Zhello</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00Zworld</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00"</span>
Coll: <span class="o">[</span>120 100 62 49 0 90 104 101 108 108 111 0 0 90 119 111 114 108 100 0 0 0]
</code></pre></div></div>

<h3 id="reference">Reference</h3>

<ul>
  <li><a href="https://tools.ietf.org/html/rfc7159">The JavaScript Object Notation (JSON) Data Interchange Format</a></li>
  <li><a href="collate.pdf">Efficient Lexicographic Encoding of Numbers</a></li>
</ul>



  

</div>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/jsonsort.io/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sorting Json data, crazy fast !</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            
              Sorting Json data, crazy fast !
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <span>&copy</span>2013 R Pratap Chakravarthy
      </div>

      <div class="footer-col footer-col-3">
        <ul class="social-media-list">
  
  
  
  
  
  
  
  
  
  
  
</ul>

      </div>
    </div>

  </div>

</footer>


  </body>

</html>
